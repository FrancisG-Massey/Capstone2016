{
    "before": "
        SELECT user_id FROM users u JOIN session s ON u.user_id = s.session_userid
        WHERE (#string:session-token# IS NOT NULL) AND (s.session_token = #string:session-token#);
    ",
    "GET" : "
        WITH logged_user AS (
            SELECT
                user_id,
                user_isadmin,
                user_isinactive
            FROM users u
            JOIN session s ON u.user_id = s.session_userid
            WHERE (#string:session-token# IS NOT NULL) AND (s.session_token = #string:session-token#)
            LIMIT 1
        ),

        -- Common Catches
        -- This may get slow, but we can abstract to a view later if required
        -- Likely can be better implemented with a window function, but time is of the essence...
        cc AS (
            SELECT
                tl.trapline_id,
                c.catch_catchtypeid,
                ct.catchtype_name,
                COUNT (*) as catches_of_type
            FROM
                catch c
                JOIN catchtype ct ON ct.catchtype_id = c.catch_catchtypeid
                JOIN trap t ON t.trap_id = c.catch_trapid
                JOIN trapline tl ON tl.trapline_id = t.trap_traplineid
            WHERE
                -- Exclude 'other' from becoming a common catch-type
                c.catch_catchtypeid <> 10000
            GROUP BY
                tl.trapline_id,
                c.catch_catchtypeid,
                ct.catchtype_name
            ORDER BY
                catches_of_type DESC
        )

        SELECT
            tl.trapline_id AS id,
            tl.trapline_name AS name,
            tl.trapline_regionid AS region_id,
            tl.trapline_starttag AS start_tag,
            tl.trapline_endtag AS end_tag,
            tl.trapline_imagefilename AS img_filename,
            (SELECT cc.catch_catchtypeid FROM cc WHERE cc.trapline_id = tl.trapline_id LIMIT 1 OFFSET 0) AS common_ct_id_1,
            (SELECT cc.catch_catchtypeid FROM cc WHERE cc.trapline_id = tl.trapline_id LIMIT 1 OFFSET 1) AS common_ct_id_2,
            (SELECT cc.catch_catchtypeid FROM cc WHERE cc.trapline_id = tl.trapline_id LIMIT 1 OFFSET 2) AS common_ct_id_3,
            tl.trapline_defaultbaitid AS default_bait_id,
            tl.trapline_defaulttraptypeid AS default_traptype_id
        FROM
            logged_user lu,
            trapline tl
            LEFT JOIN traplineuser tlu
                ON tlu.traplineuser_traplineid = tl.trapline_id
        WHERE
            (lu.user_isinactive = false) AND
            ((lu.user_isadmin = true) OR (tlu.traplineuser_userid = lu.user_id)) AND
            ((#bigint:id# IS NULL) OR (tl.trapline_id = #bigint:id#)) AND
            ((#bigint:region-id# IS NULL) OR (tl.trapline_regionid = #bigint:region-id#)) AND
            ((#string:name# IS NULL) OR (lower(tl.trapline_name) LIKE lower('%' || #string:name# || '%')))
        GROUP BY
            tl.trapline_id
        ORDER BY
            tl.trapline_id;
    ",
    "POST" : "
        INSERT INTO trapline (
            trapline_name,
            trapline_regionid,
            trapline_starttag,
            trapline_endtag,
            trapline_imagefilename,
            trapline_defaultbaitid,
            trapline_defaulttraptypeid
        )
        SELECT
            #string:name#,
            #bigint:region_id#,
            #string:start_tag#,
            #string:end_tag#,
            #string:img_filename#,
            #bigint:default_bait_id#,
            #bigint:default_traptype_id#
        WHERE
            (#bigint:id# IS NULL) AND
            (#string:name# IS NOT NULL) AND (#bigint:region_id# IS NOT NULL)
        RETURNING
            trapline_id;
    ",
    "PUT" : "",
    "DELETE" : ""
}