{
    "before": "
        SELECT * FROM extend_session(#string:session-token#::text, #string:session-timeout#::interval) es WHERE es IS NOT NULL;
    ",
    "GET" : "
        WITH logged_user AS (
            SELECT
                user_id,
                user_isadmin
            FROM users u
            JOIN session s ON u.user_id = s.session_userid
            WHERE (#string:session-token# IS NOT NULL) AND (s.session_token = #string:session-token#)
            LIMIT 1
        )

        SELECT
            u.user_id as id, 
            u.user_name as username,
            u.user_contactfullname as fullname,
            u.user_contactemail as email,
            u.user_contactphone as phone,
            u.user_createdtimestamp as created_timestamp, 
            u.user_createduserid as created_user_id, 
            u.user_isadmin as admin, 
            u.user_isinactive as inactive
        FROM
            logged_user lu,
            users u
            LEFT JOIN traplineuser tlu ON tlu.traplineuser_userid = u.user_id
        WHERE
            ((lu.user_isadmin = true) OR (tlu.traplineuser_userid = lu.user_id) OR (u.user_id = lu.user_id)) AND
            ((#bigint:id# IS NULL) OR (u.user_id = #bigint:id#)) AND
            ((#bigint:created-user-id# IS NULL) OR (u.user_createduserid = #bigint:created-user-id#)) AND
            ((#string:name# IS NULL) OR (lower(u.user_name) LIKE lower('%' || #string:name# || '%'))) AND
            ((#boolean:admin# IS NULL) OR (u.user_isadmin = #boolean:admin#)) AND

            -- Only allow admins to filter by inactive flag, return only active by default
            ((((#boolean:inactive# IS NULL) OR (#boolean:inactive# = false)) AND (u.user_isinactive = false)) OR 
            ((#boolean:inactive# IS NOT NULL) AND (#boolean:inactive# = true) AND (lu.user_isadmin = true) AND (u.user_isinactive = true)))

        GROUP BY
            u.user_id
        ORDER BY
            u.user_id;
    ",
    "POST" : "
        INSERT INTO users (
            user_name,
            user_password,
            user_contactfullname,
            user_contactphone,
            user_contactemail,
            user_createdtimestamp,
            user_createduserid,
            user_isadmin,
            user_isinactive
        )
        SELECT
            #string:username#,
            #string-bcrypt:password#,
            #string:fullname#,
            #string:phone#,
            #string:email#,
            now()::timestamp,
            1,
            #boolean:admin#,
            #boolean:inactive#
        WHERE
            (#bigint:id# IS NULL) AND 
            (#string:username# IS NOT NULL) AND (#string:password# IS NOT NULL)
        RETURNING
            user_id;
    ",
    "PUT" : "
        UPDATE users
        SET
            user_name = #string:username#,
            user_password = #string-bcrypt:password#,
            user_contactfullname = #string:fullname#,
            user_contactphone = #string:phone#,
            user_contactemail = #string:email#,
            user_isadmin = #boolean:admin#
        WHERE 
            user_id = #bigint:id#
        RETURNING
            user_id;
    ",
    "DELETE" : "
        UPDATE users
        SET
            user_isinactive = true
        WHERE
            user_id = #bigint:id#
        RETURNING user_id;

        DELETE FROM session s
        WHERE s.session_userid = #bigint:id#;

        DELETE FROM users
        WHERE 
            (user_id = #bigint:id#) AND
            (#bigint:id# NOT IN (SELECT traplineuser_userid FROM traplineuser)) AND
            (#bigint:id# NOT IN (SELECT catch_userid FROM catch));
    "
}