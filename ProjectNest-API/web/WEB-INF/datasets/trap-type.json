{
    "before": "
        SELECT
            es.user_id,
            es.user_isadmin,
            es.session_expirestimestamp
        FROM 
            extend_session(
                #string:session-token#::text, 
                #string:session-timeout#::interval
            ) es 
        WHERE es IS NOT NULL;
    ",
    "GET" : "
        WITH has_admin AS (
            SELECT (count(*) > 0)::boolean as is_admin
            FROM (
                SELECT 
                    true WHERE #boolean:logged-user-isadmin# = true
                UNION
                SELECT 
                    tlu.traplineuser_isadmin 
                FROM 
                    traplineuser tlu
                WHERE 
                    tlu.traplineuser_userid = #bigint:logged-user-id#
            ) cte_ha
        )
        SELECT 
            tt.traptype_id as id,
            tt.traptype_name as name,
            tt.traptype_model as model,
            tt.traptype_note as note,
            tt.traptype_isinactive as inactive,
            ha.is_admin as can_edit
        FROM 
            traptype tt,
            has_admin ha
        WHERE
            ((#bigint:id# IS NULL) OR (tt.traptype_id = #bigint:id#)) AND
            ((#string:name# IS NULL) OR (lower(tt.traptype_name) LIKE lower('%' || #string:name# || '%'))) AND

            -- Only allow admins to filter by inactive flag, return only active by default
            ((((#boolean:inactive# IS NULL) OR (#boolean:inactive# = false)) AND (tt.traptype_isinactive = false)) OR 
            ((#boolean:inactive# IS NOT NULL) AND (#boolean:inactive# = true) AND (#boolean:logged-user-isadmin# = true) AND (tt.traptype_isinactive = true)))

        GROUP BY
            tt.traptype_id,
            ha.is_admin
        ORDER BY
            tt.traptype_id;
    ",
    "POST" : "
        INSERT INTO traptype (
            traptype_name,
            traptype_model,
            traptype_note
        )
        SELECT
            #string:name#,
            #string:model#,
            #string:note#
        WHERE
            (#bigint:id# IS NULL)
        RETURNING
            traptype_id;
    ",
    "PUT" : "
        UPDATE traptype
        SET
            traptype_name = #string:name#,
            traptype_model = #string:model#,
            traptype_note = #string:note#
        WHERE 
            traptype_id = #bigint:id#
        RETURNING
            traptype_id;
    ",
    "DELETE" : "
        UPDATE traptype
        SET
            traptype_isinactive = true
        WHERE
            traptype_id = #bigint:id#
        RETURNING traptype_id;

        DELETE FROM traptype
        WHERE 
            (traptype_id = #bigint:id#) AND
            (#bigint:id# NOT IN (SELECT trapline_defaulttraptypeid FROM trapline)) AND
            (#bigint:id# NOT IN (SELECT trap_traptypeid FROM trap)) AND
            (#bigint:id# NOT IN (SELECT catch_traptypeid FROM catch));
    "
}